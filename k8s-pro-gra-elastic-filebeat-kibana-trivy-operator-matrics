## Accessing Trivy Operator Metrics through a Grafana Dashboard

In this tutorial, we showcase how you can access the metrics from your Trivy Operator reports through Grafana.

### Prerequisites

* The Helm CLI installed
* Access a Kubernetes cluster through kubectl (any cluster will do, however, if you use microk8s or another local Kubernetes cluster, you need to make sure DNS is enabled. Most providers will have a guide on how to enable it.)

### Installing Prometheus and Grafana

Prometheus and Grafana can easily be installed throught the kube-prometheus-stack [Helm Chart.](https://github.com/prometheus-community/helm-charts/tree/main/charts/kube-prometheus-stack)

First, create a `monitoring` namespace in which we can install the Prometheus & Grafana resources:
```
kubectl create ns monitoring
```

Add the chart to your Helm CLI:
```
helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
```

Then update your charts to access the latest versions:
```
helm repo update
```

Our Prometheus installation needs to be slightly customised to discover ServiceMonitors by default. Create a values.yaml file with the following configuration:
```
prometheus:
  prometheusSpec:
    serviceMonitorSelectorNilUsesHelmValues: false
    serviceMonitorSelector: {}
    serviceMonitorNamespaceSelector: {}
```

If you are working on a more complext installation or you would like the Helm Chart to connect with other applications such as Promtail or other monitoring tools, 
the values.yaml file is a good place to set up those configuration.

Next, install the Helm Chart:
```
helm upgrade --install prom prometheus-community/kube-prometheus-stack -n monitoring --values values.yaml
```

Note that if your values.yaml file is saved in a different directory than your current directory, then please modify its path.

You should see a success message upon installation similar to the following:
```
Release "prom" does not exist. Installing it now.
NAME: prom
LAST DEPLOYED: Fri Nov 25 11:21:24 2022
NAMESPACE: monitoring
STATUS: deployed
REVISION: 1
NOTES:
kube-prometheus-stack has been installed. Check its status by running:
  kubectl --namespace monitoring get pods -l "release=prom"

Visit https://github.com/prometheus-operator/kube-prometheus for instructions on how to create & configure Alertmanager and Prometheus instances using the Operator.
```

### Installing the Trivy Operator Helm Chart

In this section, we will install the Trivy Operator Helm Chart. The commands are provided in the [documentation](https://aquasecurity.github.io/trivy-operator/v0.7.1/operator/installation/helm/).

```
helm repo add aqua https://aquasecurity.github.io/helm-charts/
helm repo update
```

Before we install the operator, we will need to create a values.yaml file for Trivy with some slight changes to the Helm installation:
```
serviceMonitor:
  # enabled determines whether a serviceMonitor should be deployed
  enabled: true
trivy:
  ignoreUnfixed: true
```
In the changes above, we tell the Trivy Helm Chart to first, enable the ServiceMonitor and then to ignore all vulnerabilities that do not have a fix available yet. 
The ServiceMonitor is required to allow Prometheus to discover the Trivy Operator Service and scrape its metrics.

Next, we can install the operator with the following command:
```
helm install trivy-operator aqua/trivy-operator \
  --namespace trivy-system \
  --create-namespace \
  --version 0.10.1 \
  --values trivy-values.yaml
```

Ensure that you can see the following success message:
```
NAME: trivy-operator
LAST DEPLOYED: Fri Nov 25 12:46:35 2022
NAMESPACE: trivy-system
STATUS: deployed
REVISION: 1
TEST SUITE: None
NOTES:
You have installed Trivy Operator in the trivy-system namespace.
It is configured to discover Kubernetes workloads and resources in
all namespace(s).
```

### Open the Prometheus and the Grafana Dashboard

With the following command, you can access the Prometheus Dashboard:
```
kubectl port-forward service/prom-kube-prometheus-stack-prometheus -n monitoring 9090:9090
```

Next, open a new terminal and access the Grafana Dashboard:
```
kubectl port-forward service/prom-grafana -n monitoring 3000:80
```

### Access Trivy Operator Metrics

In a new terminal, we are going to port-forward to the Trivy Operator service to access the metrics provided by the operator. 

Note that this operation is optional and just used to demonstrate where you can find the metrics to then query them in a better way through Prometheus and Grafana.

Run the following command to port-forward the Trivy Operator Service:

```
kubectl port-forward service/trivy-operator -n trivy-system 5000:80
```

Once you open the 'http://localhost:5000/metrics' you should see all the metrics gathered from the operator. However, this is obviously not the prettiest way of looking at them. 
Thus, the next sections will show you how to query metrics through Prometheus and visualise them in Grafana. 

### Query Trivy Operator Metrics in Prometheus

Open the Prometheus Dashboard at 'localhost:9090' through the port-forwarding done in the previous section of this tutorial.

At this point, navigate to: `Status` < `Targets` -- and make sure that the Trivy endpoint is healthy and Prometheus can scrape its metrics.

Next, head back to 'Graph' -- http://localhost:9090/graph. Here you can already query certain metrics from the Trivy Operator. The query langiage used is basic PromQL.
There are lots of guides online that can give you inspiration. Try for instance the following queries:

Total vulnerabilities found in your cluster:
```
sum(trivy_image_vulnerabilities)
```

Total misconfiguration identified in your cluster:
```
sum(trivy_resource_configaudits)
```

Exposed Secrets discovered by the Trivy Operator in your cluster:
```
sum(trivy_image_exposedsecrets)
```

### Set up Grafana Dashboard for Trivy Operator Metrics

Lastly, we want to visualise the security issues within our cluster in a Grafana Dashboard.

For this, navigate to the Grafana URL 'http://localhost:3000'.

Username: admin
Password: prom-operator

Note that the password will be different, depending on how you called the Helm Chart installation of the kube-prometheus-stack Helm Chart earlier in the tutorial.

Next, navigate to `Dashboards` < `Browse`

Once you see all the default Dashboards, click `New`, then `Import`. 

Here, we will paste the ID of the Aqua Trivy Dashboard:
`17813`

The link to the Dashboard in Grafana is [the following.](https://grafana.com/grafana/dashboards/17813)

Once pasted, you should see the following Dashboard as part of your Dashboard list: `Trivy Operator Dashboard`

![Trivy Operator Dashbaord in Grafana Screenshot](../images/trivy-grafana.png)



###  twtech full installation stack for kubenertes cluster, prometheus, grafana, elasticsearch , filebeat, kibana, trivy operator.

#!/bin/bash
# common.sh
# copy this script and run in all master and worker nodes
#i1) Switch to root user [ sudo -i]

sudo hostnamectl set-hostname  master
sudo -i

#2) Disable swap & add kernel settings

swapoff -a
sed -i '/ swap / s/^\(.*\)$/#\1/g' /etc/fstab


#3) Add  kernel settings & Enable IP tables(CNI Prerequisites)

cat <<EOF | sudo tee /etc/modules-load.d/k8s.conf
overlay
br_netfilter
EOF

modprobe overlay
modprobe br_netfilter

cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-iptables  = 1
net.bridge.bridge-nf-call-ip6tables = 1
net.ipv4.ip_forward                 = 1
EOF

sysctl --system

#4) Install containerd run time

#To install containerd, first install its dependencies.

apt-get update -y
apt-get install ca-certificates curl gnupg lsb-release -y

#Note: We are not installing Docker Here.Since containerd.io package is part of docker apt repositories hence we added docker repository & it's key to download and install containerd.
# Add Docker’s official GPG key:
sudo mkdir -p /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg

#Use follwing command to set up the repository:

echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
  $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

# Install containerd

apt-get update -y
apt-get install containerd.io -y

# Generate default configuration file for containerd

#Note: Containerd uses a configuration file located in /etc/containerd/config.toml for specifying daemon level options.
#The default configuration can be generated via below command.

containerd config default > /etc/containerd/config.toml

# Run following command to update configure cgroup as systemd for contianerd.

sed -i 's/SystemdCgroup \= false/SystemdCgroup \= true/g' /etc/containerd/config.toml

# Restart and enable containerd service

systemctl restart containerd
systemctl enable containerd

#5) Installing kubeadm, kubelet and kubectl

# Update the apt package index and install packages needed to use the Kubernetes apt repository:

apt-get update
apt-get install -y apt-transport-https ca-certificates curl

# Download the Google Cloud public signing key:

curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.28/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg

# Add the Kubernetes apt repository:

echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.28/deb/ /' | sudo tee /etc/apt/sources.list.d/kubernetes.list

# Update apt package index, install kubelet, kubeadm and kubectl, and pin their version:

apt-get update
sudo apt install -y kubeadm=1.28.1-1.1 kubelet=1.28.1-1.1 kubectl=1.28.1-1.1

# apt-mark hold will prevent the package from being automatically upgraded or removed.

apt-mark hold kubelet kubeadm kubectl

# Enable and start kubelet service

systemctl daemon-reload
systemctl start kubelet
systemctl enable kubelet.service

# install dependencies for helm and Node-Exporter
sudo timedatectl set-timezone America/New_York
sudo apt update -y
sudo apt install tree nano unzip wget vim git -y 
sudo apt install net-tools -y
sudo apt remove java* -y
sudo apt install openjdk-17-jre   -y 

#Enable PasswordAuthentication in the server
sudo sed -i "/^[^#]*PasswordAuthentication[[:space:]]no/c\PasswordAuthentication yes" /etc/ssh/sshd_config
sudo service sshd restart

#install aws-cli for ubuntu
# https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html
curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
unzip awscliv2.zip
sudo ./aws/install

#install helm chart on ubuntu
#https://helm.sh/docs/intro/install/
curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
chmod 700 get_helm.sh
./get_helm.sh

# link: https://github.com/AnaisUrlichs/trivy-operator/blob/grafana/docs/tutorials/grafana-dashboard.md
# other Recommendation for prometheus to run on server: at least 2core cpu, 25G disk space. 
# Assign root disk at 80G:  for kubeadm,  and monitiring-observability -  prometheus, grafana, elastic logstashsearc ,  kibana 


# Add the Prometheus Community Helm repository:
helm repo add prometheus-community https://prometheus-community.github.io/helm-charts

# Create a Kubernetes namespace for the Node Exporter:
kubectl create namespace monitoring  

# Add the chart for helm CLI
helm repo add prometheus-community https://prometheus-community.github.io/helm-charts

# update your charts to access the latest versions:
helm repo update

# install prometheus using the install the Helm Chart:
helm upgrade --install prom prometheus-community/kube-prometheus-stack -n monitoring 


# Install the Node Exporter using Helm:
helm install prometheus-node-exporter prometheus-community/prometheus-node-exporter --namespace monitoring 

# Installing the Trivy Operator Helm Chart 

helm repo add aqua https://aquasecurity.github.io/helm-charts/
helm repo update

# install elasticsearch-logstash-kibana in kubernetes

# Clone the repository 
git clone https://github.com/shawon100/elasticsearch-logstash-kibana-kubernetes 

# add the helm repo

helm repo add elastic https://helm.elastic.co

# Create and Apply the persistent volumes for elastic search. 
kubectl apply –f pv.yaml
#  install elasticsearch. 
helm install elasticsearch elastic/elasticsearch --version="7.17.3" -f values.yaml --namespace monitoring 

# Create and Apply the persistent volumes for filebeat. 

kubectl apply –f pv.yaml

#  Install filebeat 
helm install filebeat elastic/filebeat --version="7.17.3" -f values.yaml --namespace monitoring 

# Install kibana using helm. 

helm install kibana  --version="7.17.3"  elastic/kibana --namespace monitoring 


# install latest trivy operator:
# check latest operator here: https://aquasecurity.github.io/trivy-operator/v0.7.1/operator/installation/helm/
helm install trivy-operator aqua/trivy-operator \
  --namespace trivy-system \
  --create-namespace \
  --version 0.23.1 
  
#### manual configurations, initializing and updating 
# ## initialize the control plane 

#   sudo kubeadm init

# #  Create kubeconfig file for authentication of the cluster
# mkdir -p $HOME/.kube
# sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
# sudo chown $(id -u):$(id -g) $HOME/.kube/config

# # create namespace dev and set context to dev:
# kubectl create namespace dev
# kubectl config set-context --current --namespace=dev

# # install Weave network plugin 
# kubectl apply -f https://github.com/weaveworks/weave/releases/download/v2.8.1/weave-daemonset-k8s.yaml

## manually upgrade  the prometheus values with --values values.yaml file configured
# link : https://github.com/Devopspat35/Package-management/blob/master/installing-trivy-operation-for%20prometheus-grafan


## manually upgrade alert with yaml file from link:
# https://github.com/Devopspat35/Package-management/blob/master/installing-trivy-operation-for%20prometheus-grafan
# helm upgrade prometheus prometheus-community/kube-prometheus-stack -f alert.yaml -n monitoring


# manually create the trivy-values.yaml file
# manually update the trivy operator with trivy-values.yaml file
# https://github.com/Devopspat35/Package-management/blob/master/installing-trivy-operation-for%20prometheus-grafan

# helm upgrade --install trivy-operator aqua/trivy-operator \
 #--namespace trivy-system \
 #--create-namespace \
 #--version 0.23.1 \
 #--values trivy-values.yaml


## manually generate the kubeadm join token to bootstrap worker-nodes

# kubeadm token create --print-join-command

# manually  update trviy operator using the trivy-values.yaml file
# https://github.com/Devopspat35/Package-management/blob/master/installing-trivy-operation-for%20prometheus-grafan 


# list all services and edit for grafana, and kibana -n monitoring ( kibana, prometheus) 
# manually install the matric server to scrap the logs using a yaml file from the link below:
# https://github.com/Devopspat35/Package-management/blob/master/install-metric-server-k8s.yaml

# verify:
# aws --version
# helm version 
# kubectl version 
